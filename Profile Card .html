<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operator Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        eros: { accent: '#059669', text: '#334155' }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    animation: {
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; color: #334155; }
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 20px 40px -5px rgba(0, 0, 0, 0.05);
        }
        .security-pattern {
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
        }
        /* 头像上传的悬停遮罩 */
        .avatar-overlay {
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .avatar-container:hover .avatar-overlay {
            opacity: 1;
        }
        /* 编辑框样式 */
        .edit-input {
            background: transparent;
            border: none;
            border-bottom: 2px solid #059669;
            color: #1e293b;
            font-family: 'JetBrains Mono', monospace;
            width: 100%;
            outline: none;
            padding: 0;
            margin: 0;
        }
    </style>
</head>
<body class="h-screen w-full flex items-center justify-center security-pattern overflow-hidden p-4">

    <div class="w-full max-w-md animate-slide-up">
        <!-- 身份卡片主体 -->
        <div class="glass-card rounded-2xl overflow-hidden relative group">
            
            <!-- 顶部装饰 -->
            <div class="h-2 bg-gradient-to-r from-emerald-500 via-emerald-400 to-emerald-500"></div>
            
            <!-- 头部：Logo与状态 -->
            <div class="px-8 pt-8 pb-4 flex justify-between items-start">
                <div>
                    <h1 class="text-2xl font-black text-slate-800 tracking-tighter">PROJECT EROS</h1>
                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.3em] mt-1">Operator Identity</div>
                </div>
                <div class="flex flex-col items-end">
                    <div class="px-2 py-1 bg-emerald-50 text-emerald-600 border border-emerald-100 rounded text-[10px] font-bold uppercase tracking-wider flex items-center gap-1.5">
                        <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                        Active
                    </div>
                </div>
            </div>

            <!-- 核心信息区 -->
            <div class="px-8 py-4 flex items-center gap-6">
                <!-- 头像框 -->
                <div class="avatar-container relative w-24 h-24 bg-slate-50 border-2 border-slate-100 rounded-xl flex items-center justify-center shadow-inner flex-shrink-0 cursor-pointer overflow-hidden" onclick="document.getElementById('avatar-input').click()">
                    <!-- 默认图标 -->
                    <i id="default-avatar-icon" class="fa-solid fa-user-secret text-4xl text-slate-300"></i>
                    <!-- 用户上传的图片 (默认隐藏) -->
                    <img id="user-avatar-img" src="" class="absolute inset-0 w-full h-full object-cover hidden" alt="Avatar">
                    
                    <!-- 悬停提示 -->
                    <div class="avatar-overlay absolute inset-0 bg-black/40 flex items-center justify-center text-white backdrop-blur-[2px]">
                        <i class="fa-solid fa-camera"></i>
                    </div>
                    
                    <!-- 隐藏的文件输入 -->
                    <input type="file" id="avatar-input" class="hidden" accept="image/*" onchange="handleAvatarUpload(this)">
                </div>
                
                <!-- 名字 -->
                <div class="flex-1 min-w-0 group/name relative">
                    <div class="text-xs font-bold text-slate-400 uppercase mb-1">Codename</div>
                    
                    <!-- 显示模式 -->
                    <div id="name-display-area" class="flex items-center gap-2">
                        <h2 id="card-name" class="text-3xl font-bold text-slate-800 truncate font-mono tracking-tight cursor-pointer hover:text-emerald-600 transition" onclick="startEditingName()" title="Click to rename">--</h2>
                        <button onclick="startEditingName()" class="text-slate-300 hover:text-emerald-500 transition opacity-0 group-hover/name:opacity-100">
                            <i class="fa-solid fa-pencil text-sm"></i>
                        </button>
                    </div>

                    <!-- 编辑模式 (默认隐藏) -->
                    <div id="name-edit-area" class="hidden">
                        <input type="text" id="name-input" class="edit-input text-3xl font-bold font-mono" onblur="saveName()" onkeydown="if(event.key==='Enter') saveName()">
                    </div>

                    <div class="mt-2 flex items-center gap-2">
                        <span class="text-[10px] text-emerald-600 font-bold">Authorized Personnel</span>
                    </div>
                </div>
            </div>

            <!-- 数据栅格 -->
            <div class="px-8 py-6 pb-8">
                <div class="grid grid-cols-2 gap-4">
                    <div class="p-3 bg-slate-50/50 rounded-lg border border-slate-100">
                        <div class="text-[10px] text-slate-400 font-bold uppercase mb-1">Activation Date</div>
                        <div id="card-join-date" class="text-sm font-mono font-bold text-slate-700">--</div>
                    </div>
                    <!-- 修改：去除了原先的 Valid Until 动态计算，改为静态买断制展示 -->
                    <div class="p-3 bg-emerald-50/50 rounded-lg border border-emerald-100">
                        <div class="text-[10px] text-emerald-600 font-bold uppercase mb-1">Access Level</div>
                        <div class="text-sm font-mono font-bold text-emerald-700">Lifetime</div>
                    </div>
                </div>
                
                <!-- 权限列表 -->
                <div class="mt-6 space-y-3">
                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-2 mb-3">System Access</div>
                    
                    <div class="flex items-center justify-between text-sm group/item">
                        <span class="text-slate-600 flex items-center gap-2"><i class="fa-solid fa-map text-emerald-500 w-4"></i> Campaign Map</span>
                        <i class="fa-solid fa-check text-emerald-500 text-xs"></i>
                    </div>
                    <div class="flex items-center justify-between text-sm group/item">
                        <span class="text-slate-600 flex items-center gap-2"><i class="fa-solid fa-stopwatch text-emerald-500 w-4"></i> Edge Control</span>
                        <i class="fa-solid fa-check text-emerald-500 text-xs"></i>
                    </div>
                    <div class="flex items-center justify-between text-sm group/item opacity-50">
                        <span class="text-slate-400 flex items-center gap-2"><i class="fa-solid fa-users text-slate-300 w-4"></i> Community</span>
                        <i class="fa-solid fa-lock text-slate-300 text-xs"></i>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        const DB_KEY = 'eros_v5_fixed_data';

        function findEarliestActivityDate() {
            let earliest = null;
            const updateEarliest = (dateStr) => {
                if (!dateStr) return;
                const d = new Date(dateStr);
                if (!isNaN(d.getTime())) {
                    if (!earliest || d < earliest) earliest = d;
                }
            };
            try { JSON.parse(localStorage.getItem('edge_history') || '[]').forEach(item => updateEarliest(item.date)); } catch(e) {}
            try { JSON.parse(localStorage.getItem('kegel_history') || '[]').forEach(item => updateEarliest(item.date)); } catch(e) {}
            try { Object.keys(JSON.parse(localStorage.getItem('body_builder_data') || '{}')).forEach(key => updateEarliest(key)); } catch(e) {}
            try { Object.keys(JSON.parse(localStorage.getItem('eros_daily_logs') || '{}')).forEach(key => updateEarliest(key)); } catch(e) {}
            return earliest;
        }

        function init() {
            const raw = localStorage.getItem(DB_KEY);
            let data = null;
            try { data = JSON.parse(raw); } catch(e) {}
            if (!data) data = { user: { username: "Guest" } }; 

            if (!data.user) data.user = {};
            const name = data.user.username || "Operator";
            let joinDateStr = data.user.join_date;
            
            // 日期回溯修复逻辑
            if (!joinDateStr) {
                const historyEarliest = findEarliestActivityDate();
                joinDateStr = historyEarliest ? historyEarliest.toISOString() : new Date().toISOString();
                data.user.join_date = joinDateStr;
                localStorage.setItem(DB_KEY, JSON.stringify(data));
            } else {
                const historyEarliest = findEarliestActivityDate();
                const currentJoinDate = new Date(joinDateStr);
                if (historyEarliest && historyEarliest < currentJoinDate) {
                    joinDateStr = historyEarliest.toISOString();
                    data.user.join_date = joinDateStr;
                    localStorage.setItem(DB_KEY, JSON.stringify(data));
                }
            }

            // 渲染
            if (data.user.avatar) {
                document.getElementById('user-avatar-img').src = data.user.avatar;
                document.getElementById('user-avatar-img').classList.remove('hidden');
                document.getElementById('default-avatar-icon').classList.add('hidden');
            }

            document.getElementById('card-name').innerText = name;

            const joinDate = new Date(joinDateStr);
            const fmt = (d) => `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')}`;
            document.getElementById('card-join-date').innerText = fmt(joinDate);
            
            // 修改：已删减 expiryDate 的计算与 DOM 操作
        }

        // --- 改名功能 ---
        function startEditingName() {
            const displayArea = document.getElementById('name-display-area');
            const editArea = document.getElementById('name-edit-area');
            const input = document.getElementById('name-input');
            const currentName = document.getElementById('card-name').innerText;

            input.value = currentName;
            displayArea.classList.add('hidden');
            editArea.classList.remove('hidden');
            input.focus();
        }

        function saveName() {
            const displayArea = document.getElementById('name-display-area');
            const editArea = document.getElementById('name-edit-area');
            const input = document.getElementById('name-input');
            const newName = input.value.trim();

            if (newName) {
                // 更新 UI
                document.getElementById('card-name').innerText = newName;
                
                // 保存数据
                let data = {};
                try { data = JSON.parse(localStorage.getItem(DB_KEY)); } catch(e){}
                if (!data) data = { user: {} };
                if (!data.user) data.user = {};
                
                data.user.username = newName;
                localStorage.setItem(DB_KEY, JSON.stringify(data));

                // 尝试刷新父级侧边栏
                try { window.parent.updateDashboardUI(); } catch(e) {}
            }

            editArea.classList.add('hidden');
            displayArea.classList.remove('hidden');
        }

        function handleAvatarUpload(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                if (file.size > 2 * 1024 * 1024) return alert("图片太大，请选择小于 2MB 的图片");

                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64 = e.target.result;
                    const img = document.getElementById('user-avatar-img');
                    const icon = document.getElementById('default-avatar-icon');
                    img.src = base64;
                    img.classList.remove('hidden');
                    icon.classList.add('hidden');

                    try {
                        const raw = localStorage.getItem(DB_KEY);
                        let data = raw ? JSON.parse(raw) : { user: {} };
                        if (!data.user) data.user = {};
                        data.user.avatar = base64;
                        localStorage.setItem(DB_KEY, JSON.stringify(data));
                    } catch (err) {
                        alert("图片保存失败");
                    }
                }
                reader.readAsDataURL(file);
            }
        }

        window.onload = init;
    </script>
</body>
</html>
