<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Settings</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { eros: { accent: '#059669', text: '#334155' } },
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; color: #334155; }
        .setting-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            transition: all 0.2s;
        }
        .setting-card:hover {
            border-color: #cbd5e1;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="p-6 md:p-10 max-w-4xl mx-auto pb-20">

    <header class="mb-10">
        <h1 class="text-3xl font-black text-slate-800 tracking-tight mb-2">SYSTEM CONSOLE</h1>
        <p class="text-sm text-slate-400 font-mono">DATA MANAGEMENT // STORAGE DIAGNOSTICS</p>
    </header>

    <div class="space-y-8">

        <!-- 1. 存储状态仪表盘 -->
        <section>
            <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                <i class="fa-solid fa-hard-drive"></i> Local Database Status
            </h2>
            <div class="setting-card p-6">
                <div class="flex items-end justify-between mb-4">
                    <div>
                        <div class="text-2xl font-bold text-slate-700 font-mono"><span id="storage-used">0</span> KB</div>
                        <div class="text-xs text-slate-400">Total Local Storage Used</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded border border-emerald-100">HEALTHY</div>
                    </div>
                </div>
                
                <div class="w-full bg-slate-100 rounded-full h-2 mb-2 overflow-hidden">
                    <div class="bg-slate-800 h-2 rounded-full" style="width: 5%"></div>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
                    <div class="p-3 bg-slate-50 rounded border border-slate-100 text-center">
                        <div class="text-[10px] text-slate-400 uppercase">Training Logs</div>
                        <div id="count-edge" class="text-sm font-bold text-slate-700 font-mono">0</div>
                    </div>
                    <div class="p-3 bg-slate-50 rounded border border-slate-100 text-center">
                        <div class="text-[10px] text-slate-400 uppercase">Kegel Sets</div>
                        <div id="count-kegel" class="text-sm font-bold text-slate-700 font-mono">0</div>
                    </div>
                    <div class="p-3 bg-slate-50 rounded border border-slate-100 text-center">
                        <div class="text-[10px] text-slate-400 uppercase">Daily Journal</div>
                        <div id="count-journal" class="text-sm font-bold text-slate-700 font-mono">0</div>
                    </div>
                    <div class="p-3 bg-slate-50 rounded border border-slate-100 text-center">
                        <div class="text-[10px] text-slate-400 uppercase">System Ver.</div>
                        <div class="text-sm font-bold text-slate-700 font-mono">5.2.Cloud</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 2. [已修改] 云端同步模块 (Cloud Synchronization) -->
        <section>
            <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                <i class="fa-solid fa-cloud"></i> Cloud Synchronization
            </h2>
            <div class="setting-card p-6">
                <div class="flex flex-col md:flex-row items-center justify-between gap-6">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <h3 class="font-bold text-slate-800">Eros Cloud Node</h3>
                            <span id="cloud-status-badge" class="px-2 py-0.5 bg-slate-100 text-slate-500 rounded text-[10px] font-bold uppercase tracking-wider transition-colors">Checking...</span>
                        </div>
                        <p class="text-xs text-slate-500 leading-relaxed mt-1">
                            系统在后台会自动静默同步。如遇多设备切换或数据异常，可使用下方指令进行强制干预。
                        </p>
                        <div class="mt-3 text-[10px] text-slate-400 font-mono flex items-center gap-1.5">
                            <i class="fa-regular fa-clock"></i> 上次手动同步: <span id="last-sync-time" class="text-slate-600 font-bold">--</span>
                        </div>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
                        <!-- Pull 按钮：危险操作，灰色调，防误触 -->
                        <button id="btn-pull" onclick="forcePull()" class="px-5 py-2.5 bg-white text-slate-600 border border-slate-200 rounded-lg text-sm font-bold hover:border-orange-400 hover:text-orange-600 transition flex items-center justify-center gap-2 group">
                            <i class="fa-solid fa-cloud-arrow-down group-hover:animate-bounce"></i> 覆盖本地
                        </button>
                        <!-- Push 按钮：常规安全操作，系统强调色 -->
                        <button id="btn-push" onclick="forcePush()" class="px-5 py-2.5 bg-emerald-50 text-emerald-700 border border-emerald-200 rounded-lg text-sm font-bold hover:bg-emerald-100 hover:border-emerald-300 transition flex items-center justify-center gap-2 shadow-sm">
                            <i class="fa-solid fa-cloud-arrow-up"></i> 强制上传
                        </button>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- 底部版本信息 -->
        <div class="text-center pt-8 border-t border-slate-200 mt-12">
            <p class="text-xs font-mono text-slate-400">PROJECT EROS // SYSTEM KERNEL</p>
            <p class="text-[10px] text-emerald-600/70 mt-1 font-bold">Supabase Cloud Sync Active</p>
        </div>

    </div>

    <script>
        // 定义所有涉及到的 LocalStorage Key
        const DB_KEYS = [
            'eros_v5_fixed_data', 
            'edge_history',       
            'kegel_history',      
            'body_builder_data',  
            'user_size_data',     
            'eros_daily_logs',    
            'edge_prefs',
            'rest_days'
        ];

        // --- 1. 初始化计算 ---
        function init() {
            let totalBytes = 0;
            let edgeCount = 0;
            let kegelCount = 0;
            let journalCount = 0;

            DB_KEYS.forEach(key => {
                const val = localStorage.getItem(key);
                if (val) {
                    totalBytes += val.length * 2; 
                    
                    if (key === 'edge_history') {
                        try { edgeCount = JSON.parse(val).length; } catch(e){}
                    }
                    if (key === 'kegel_history') {
                        try { kegelCount = JSON.parse(val).length; } catch(e){}
                    }
                    if (key === 'eros_daily_logs') {
                        try { 
                            const logs = JSON.parse(val);
                            journalCount = Object.values(logs).flat().length; 
                        } catch(e){}
                    }
                }
            });

            document.getElementById('storage-used').innerText = (totalBytes / 1024).toFixed(1);
            document.getElementById('count-edge').innerText = edgeCount;
            document.getElementById('count-kegel').innerText = kegelCount;
            document.getElementById('count-journal').innerText = journalCount;

            checkCloudStatus();
        }

        // --- 2. [新增] 云端连通性与状态检测 (增加了 try-catch 防止跨域报错崩溃) ---
        function checkCloudStatus() {
            const badge = document.getElementById('cloud-status-badge');
            let isConnected = false;

            try {
                // 检查父级窗口的 Supabase 实例是否存在。捕获预览环境可能抛出的跨域错误
                if (window.parent && window.parent.supabaseClient && window.parent.currentUser) {
                    isConnected = true;
                }
            } catch (error) {
                console.warn("Parent frame access blocked due to cross-origin policy. Cloud status unavailable in preview.", error);
            }
            
            if (isConnected) {
                badge.innerText = "CONNECTED";
                badge.className = "px-2 py-0.5 bg-emerald-50 text-emerald-600 border border-emerald-200 rounded text-[10px] font-bold uppercase tracking-wider";
            } else {
                badge.innerText = "OFFLINE";
                badge.className = "px-2 py-0.5 bg-slate-50 text-slate-400 border border-slate-200 rounded text-[10px] font-bold uppercase tracking-wider";
            }
            
            // 读取本地记录的同步时间戳
            const lastSync = localStorage.getItem('eros_last_sync_time');
            if (lastSync) {
                const date = new Date(parseInt(lastSync));
                document.getElementById('last-sync-time').innerText = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
            } else {
                document.getElementById('last-sync-time').innerText = "尚未手动执行";
            }
        }

        // --- 3. [新增] 强制从云端拉取 (覆盖本地) ---
        async function forcePull() {
            if (!confirm("⚠️ 危险操作确认\n\n这将从云端下载最新存档，并彻底覆盖你当前设备上的数据。如果当前设备有未上传的进度，将会永久丢失。\n\n确定要用云端数据覆盖本地吗？")) return;
            
            const btn = document.getElementById('btn-pull');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> 同步中...';
            btn.disabled = true;
            
            try {
                let syncManager = null;
                try {
                    syncManager = window.parent && window.parent.SyncManager;
                } catch (e) {
                    console.warn("Parent frame access blocked.", e);
                }

                if (syncManager) {
                    await syncManager.pullFromCloud();
                    localStorage.setItem('eros_last_sync_time', Date.now().toString());
                    alert("✅ 云端数据已成功覆盖本地！系统即将重启以应用新数据。");
                    // 强制刷新主框架
                    try { window.parent.location.reload(); } catch(e) { location.reload(); }
                } else {
                    alert("❌ 无法连接到主控台同步模块，可能是因为预览环境下的跨域安全限制 (CORS)。");
                }
            } catch (err) {
                alert("❌ 拉取失败: " + err.message);
            } finally {
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        }

        // --- 4. [新增] 强制推送到云端 (覆盖云端) ---
        async function forcePush() {
            if (!confirm("⚠️ 操作确认\n\n这将把当前设备的本地存档强行推送到云端数据库。确信当前设备的数据是最新的吗？")) return;
            
            const btn = document.getElementById('btn-push');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> 上传中...';
            btn.disabled = true;
            
            try {
                let syncManager = null;
                try {
                    syncManager = window.parent && window.parent.SyncManager;
                } catch (e) {
                    console.warn("Parent frame access blocked.", e);
                }

                if (syncManager) {
                    await syncManager.pushToCloud();
                    localStorage.setItem('eros_last_sync_time', Date.now().toString());
                    checkCloudStatus();
                    alert("✅ 本地数据已强制覆盖云端节点！");
                } else {
                    alert("❌ 无法连接到主控台同步模块，可能是因为预览环境下的跨域安全限制 (CORS)。");
                }
            } catch (err) {
                alert("❌ 上传失败: " + err.message);
            } finally {
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        }

        window.onload = init;
    </script>
</body>
</html>