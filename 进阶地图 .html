<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Eros - è¿›é˜¶åœ°å›¾ (ç‹¬ç«‹ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // [ä¿æŒåŸæ ·] ä¸¥æ ¼ä¿ç•™ demo.html çš„é…ç½®
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        eros: {
                            dark: '#f1f5f9',   // æµ…è‰²ä¸»èƒŒæ™¯
                            panel: '#ffffff',  // æµ…è‰²é¢æ¿/ä¾§è¾¹æ 
                            accent: '#059669', // Emerald 600 æ›´æ²‰ç¨³çš„ç»¿
                            muted: '#64748b',
                            text: '#334155',
                            locked: '#94a3b8'
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        }
                    },
                    transitionProperty: {
                        'height': 'height',
                        'spacing': 'margin, padding',
                    }
                }
            }
        }
    </script>
    <style>
        /* [ä¿æŒåŸæ ·] ä¸¥æ ¼ä¿ç•™ demo.html çš„æ‰€æœ‰ CSS è¦†ç›– */
        body { background-color: #f1f5f9; color: #334155; font-family: 'Inter', 'Segoe UI', system-ui, sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .backdrop-blur-sm { backdrop-filter: blur(4px); }
        .fade-transition { transition: opacity 0.3s ease-in-out; }
        
        /* æµ…è‰²ä¸»é¢˜ï¼ˆé»˜è®¤ï¼‰ï¼šæ–‡å­—ä¸è¾¹æ¡†å¼ºåˆ¶è¦†ç›– */
        body .text-white { color: #0f172a !important; }
        body .text-slate-100 { color: #1e293b !important; }
        body .text-slate-200 { color: #334155 !important; }
        body .text-slate-300 { color: #475569 !important; }
        body .text-slate-400 { color: #64748b !important; }
        body .text-slate-500 { color: #64748b !important; }
        body .text-slate-600 { color: #64748b !important; }
        body .border-slate-700 { border-color: #e2e8f0 !important; }
        body .border-slate-600 { border-color: #e2e8f0 !important; }
        body .bg-slate-700 { background-color: #e2e8f0 !important; }
        body .bg-slate-800 { background-color: #f1f5f9 !important; }
        body .bg-slate-900 { background-color: #f8fafc !important; }
        body .bg-slate-800\/50 { background-color: rgba(241, 245, 249, 0.9) !important; }
        body .bg-slate-700\/50 { background-color: rgba(226, 232, 240, 0.8) !important; }
        body .bg-slate-700\/30 { background-color: rgba(226, 232, 240, 0.6) !important; }
        body .hover\:bg-slate-700:hover { background-color: #e2e8f0 !important; }
        body .hover\:text-white:hover { color: #0f172a !important; }
        body .hover\:bg-slate-700\/30:hover { background-color: rgba(203, 213, 225, 0.6) !important; }
        
        /* æ¨¡æ€æ¡†æ ·å¼è¦†ç›– */
        body #modal-content { background-color: #ffffff !important; border-color: #e2e8f0 !important; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.12); }
        body #modal-content .text-slate-300 { color: #475569 !important; }
        body #modal-content .text-slate-100 { color: #1e293b !important; }
        body #modal-content .bg-slate-800 { background-color: #f8fafc !important; }
        body #modal-content .bg-slate-800\/50 { background-color: #f1f5f9 !important; }
        body #modal-content .border-slate-700 { border-color: #e2e8f0 !important; }
        body #modal-content .border-slate-500 { border-color: #e2e8f0 !important; }
        
        body .border-slate-600\/50 { border-color: #e2e8f0 !important; }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden selection:bg-emerald-500 selection:text-white bg-eros-dark">

    <!-- ä¸»å®¹å™¨ï¼šç›´æ¥æ˜¾ç¤ºåœ°å›¾ -->
    <div id="app-root" class="h-full w-full relative overflow-y-auto scrollbar-hide">
        <!-- å†…å®¹å°†ç”± JS æ¸²æŸ“åœ¨æ­¤å¤„ -->
    </div>

    <!-- æ¨¡æ€æ¡† (ä¿æŒåŸæ ·) -->
    <div id="modal-overlay" onclick="closeModal(event)" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div id="modal-content" class="bg-eros-panel border border-slate-600 rounded-xl p-6 w-full max-w-2xl shadow-2xl transform scale-95 transition-transform duration-300 max-h-[90vh] overflow-y-auto scrollbar-hide">
            <div class="flex justify-between items-start mb-4 border-b border-slate-700 pb-2">
                <h3 id="modal-title" class="text-2xl font-bold text-white tracking-wide"></h3>
                <button onclick="toggleModal(false)" class="text-slate-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            <div id="modal-body" class="text-slate-300 mb-6 leading-relaxed space-y-6"></div>
            <div class="flex justify-end space-x-3 hidden">
                <button onclick="toggleModal(false)" class="px-4 py-2 rounded text-slate-400 hover:bg-slate-700/50 transition">å…³é—­</button>
            </div>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒæ•°æ®ç»“æ„ (ä¿æŒåŸæ ·) ---
        const DB_KEY = 'eros_v5_fixed_data'; 
        
        // 5ç‚¹4æ®µæ¨¡å‹æ•°æ®
        const STAGES = [
            { 
                id: 1, 
                name: "è·¯äºº", 
                en_name: "STRANGER",
                definition: "ç‰©ç†ç©ºé—´æœ‰äº¤é›†ï¼Œä½†å¿ƒç†ç©ºé—´é™Œç”Ÿã€‚ç›®æ ‡æ˜¯æ‰“ç ´ç©ºæ°”å¢™ï¼Œå»ºç«‹è¿æ¥ã€‚",
                actions: [
                    "å½¢è±¡å»ºè®¾ï¼šé¢éƒ¨æ¸…æ´ï¼Œæ‹’ç»åœ†è‚©é©¼èƒŒï¼ŒClean Fitç©¿æ­ã€‚",
                    "å£°æ˜å¼å¼€åœºï¼šè¡¨æ˜æ¥æ„ï¼Œå‡å°‘ä¸å®‰å…¨æ„Ÿã€‚",
                    "æ•°å­—ç€é™†ï¼šè·å–è”ç³»æ–¹å¼åä¸»åŠ¨åˆ‡æ–­ï¼Œåˆ¶é€ å®‰å…¨æ„Ÿã€‚"
                ],
                taboos: [
                    "å¿Œæ­»ç¼ çƒ‚æ‰“ï¼šè¶…è¿‡3æ¬¡ä¸å›æ¶ˆæ¯åœæ­¢éªšæ‰°ã€‚",
                    "å¿ŒæŸ¥æˆ·å£ï¼šåˆšè®¤è¯†ä¸è¦è¿ç»­æé—®ã€‚"
                ],
                tasks: [
                    "è·å–å¾®ä¿¡/è”ç³»æ–¹å¼ï¼Œæœªè¢«æ‹’ç»",
                    "è·å¾—â€œåºŸè¯å›å¤â€ï¼ˆéåŠŸèƒ½æ€§äº’åŠ¨ï¼‰",
                    "æœ‹å‹åœˆäº’åŠ¨æƒï¼ˆç‚¹èµ/è¯„è®º/æœªå±è”½ï¼‰"
                ]
            },
            { 
                id: 2, 
                name: "æœ‹å‹", 
                en_name: "FRIEND",
                definition: "åˆ—è¡¨é‡Œçš„ç†Ÿäººï¼Œç”±äºä»»åŠ¡å®Œæˆï¼Œä½ ä»¬ç°åœ¨å·²ç»å¯ä»¥æ­£å¸¸äº¤æµã€‚",
                actions: [
                    "é«˜ä»·å€¼å±•ç¤ºï¼šæœ‹å‹åœˆä½œä¸ºç®€å†å±•ç¤ºç”Ÿæ´»ã€‚",
                    "è¯é¢˜æ·±æ½œï¼šæŒ–æ˜å…±åŒç‚¹ï¼Œåˆ†äº«éåŠŸèƒ½æ€§è‡ªæˆ‘ã€‚",
                    "æ¨¡ç³Šé‚€çº¦ï¼šä»¥â€œäº‹â€ä¸ºä¸»ï¼ˆæ¢åº—ï¼‰è¿›è¡Œä½å‹é‚€çº¦ã€‚"
                ],
                taboos: [
                    "å¿Œåšæƒ…ç»ªåƒåœ¾æ¡¶ï¼šåªå¬åæ§½ä¸è§é¢å³ä¸ºç™½å«–ã€‚",
                    "å¿Œä¾›å…»è€…æ¡†æ¶ï¼šä¸è¯•å›¾é€šè¿‡é€ç¤¼è®¨å¥½ã€‚"
                ],
                tasks: [
                    "æˆåŠŸè¿›è¡Œ 1 æ¬¡å•ç‹¬é‚€çº¦ï¼ˆ1V1ï¼‰",
                    "å¯¹æ–¹ä¸»åŠ¨å‘èµ·è¿‡è¯é¢˜åˆ†äº«",
                    "å®Œæˆ 1 æ¬¡æƒ…ç»ªæš´éœ²ï¼ˆå¥¹å‘ä½ åæ§½ï¼‰"
                ]
            },
            { 
                id: 3, 
                name: "å¥½æœ‹å‹", 
                en_name: "GOOD FRIEND",
                definition: "å…³ç³»è´¨å˜æœŸã€‚å¦‚æœä¸æ¨è¿›ï¼Œå°±ä¼šæ°¸ä¹…åœç•™åœ¨æœ‹å‹åœˆã€‚",
                actions: [
                    "è¿›æŒªï¼ˆKinoï¼‰ï¼šéµå¾ªâ€œè¿›ä¸¤æ­¥é€€ä¸€æ­¥â€åŸåˆ™ã€‚",
                    "æ¨æ‹‰è¯æœ¯ï¼šå…ˆæ‰“å‹å†èµç¾ï¼Œåˆ¶é€ æƒ…ç»ªæ³¢åŠ¨ã€‚",
                    "æ°”åœºæ§åˆ¶ï¼šä¸‰è§’å‡è§†æš—ç¤ºäº²å»ã€‚"
                ],
                taboos: [
                    "å¿Œæ”¶åˆ°å¥½äººå¡å´©æºƒï¼šè‹¥èº²é¿åˆ™è£…ä½œæ— äº‹å‘ç”Ÿã€‚",
                    "å¿Œä¸æ•¢å‡çº§ï¼šæ²¡æœ‰è‚¢ä½“æ¥è§¦æ°¸è¿œæ˜¯æœ‹å‹ã€‚"
                ],
                tasks: [
                    "è‚¢ä½“æ¥è§¦æµ‹è¯•é€šè¿‡ï¼ˆä¸èº²é¿/ä¸åƒµç¡¬ï¼‰",
                    "é»˜è®¤â€œå‡†æƒ…ä¾£â€å¾…é‡ï¼ˆå…±ç”¨å¸ç®¡/æš§æ˜§æ˜µç§°ï¼‰",
                    "è¿›è¡Œè¿‡é«˜å¼ºåº¦æ·±å¤œèŠå¤©"
                ]
            },
            { 
                id: 4, 
                name: "æš§æ˜§å¯¹è±¡", 
                en_name: "AMBIGUOUS",
                definition: "çª—æˆ·çº¸è–„å¦‚è‰ç¿¼ï¼Œåªå·®æœ€åä¸€æ­¥ç¡®è®¤ã€‚",
                actions: [
                    "ç§å¯†ç©ºé—´æ„å»ºï¼šè½¬åœºè‡³å½±é™¢/ç§Ÿæˆ¿/æ¸…å§ã€‚",
                    "çª—æˆ·çº¸ç²‰ç¢ï¼šç‰µæ‰‹ã€æ‹¥æŠ±æˆ–è¯­è¨€è¡¨ç™½ã€‚",
                    "å®‰å…¨é˜²æŠ¤ï¼šéšèº«æºå¸¦å®‰å…¨ç”¨å“ï¼Œå°Šé‡åº•çº¿ã€‚"
                ],
                taboos: [
                    "å¿Œæ¥å—å…»é±¼ï¼šäº«å—æš§æ˜§ä½†æ‹’ç»å…³ç³»ï¼Œç«‹å³åˆ‡æ–­ã€‚",
                    "å¿Œå¼ºè¡Œæ¨è¿›ï¼šNo means Noã€‚"
                ],
                tasks: [
                    "ä»ªå¼æ„Ÿç¡®è®¤ï¼ˆå£å¤´è¾¾æˆç”·å¥³æœ‹å‹å…±è¯†ï¼‰",
                    "å®è´¨æ€§äº²å¯†è¡Œä¸ºï¼ˆæ¥å»/French Kissï¼‰",
                    "ï¼ˆå¯é€‰ï¼‰å®Œæˆæœ€ç»ˆèº«å¿ƒç»“åˆ"
                ]
            },
            { 
                id: 5, 
                name: "æ‹äºº", 
                en_name: "LOVER",
                definition: "ç»ˆæç›®æ ‡è¾¾æˆã€‚å»ºç«‹æ’ä»–æ€§å¥‘çº¦å…³ç³»ï¼Œå¼€å¯é•¿æœŸå…³ç³»ç»´æŠ¤ã€‚",
                actions: [
                    "å…³ç³»å…¬å¼€ï¼šåœ¨ç¤¾äº¤åœˆæˆ–æœ‹å‹åœˆç¡®è®¤èº«ä»½ã€‚",
                    "é•¿æœŸè§„åˆ’ï¼šè®¨è®ºæœªæ¥çš„å¯èƒ½æ€§ã€‚",
                    "ç£¨åˆåŒ…å®¹ï¼šå°Šé‡å·®å¼‚ï¼Œæ±‚åŒå­˜å¼‚ã€‚"
                ],
                taboos: [
                    "å¿Œå¾—åˆ°åç«‹åˆ»æ¾æ‡ˆå½¢è±¡ç®¡ç†ã€‚",
                    "å¿Œè¿‡åº¦æ§åˆ¶æˆ–çŒœå¿Œã€‚"
                ],
                tasks: []
            }
        ];

        // é»˜è®¤ Schema
        const defaultSchema = {
            user: { username: "Guest", password: "", is_activated: true, join_date: "" },
            settings: { theme: "light", sound_enabled: true },
            campaign: { 
                current_stage: 1, 
                stage_progress: 0, 
                target_name: "", 
                history: [],
                completed_tasks: {} 
            },
            daily_logs: {} 
        };

        // --- è¿è¡Œæ—¶çŠ¶æ€ ---
        let runtimeData = null;
        const appRoot = document.getElementById('app-root');
        const modalOverlay = document.getElementById('modal-overlay');
        const modalContent = document.getElementById('modal-content');

        // --- åˆå§‹åŒ–é€»è¾‘ ---
        function init() {
            const data = localStorage.getItem(DB_KEY);
            if (!data) {
                runtimeData = JSON.parse(JSON.stringify(defaultSchema));
                runtimeData.user.join_date = new Date().toISOString();
                saveToDB(runtimeData);
            } else {
                try {
                    runtimeData = JSON.parse(data);
                    if (!runtimeData.campaign.completed_tasks) {
                        runtimeData.campaign.completed_tasks = {};
                    }
                } catch (e) {
                    console.error("å­˜æ¡£æŸåï¼Œé‡ç½®ä¸­...", e);
                    runtimeData = JSON.parse(JSON.stringify(defaultSchema));
                    saveToDB(runtimeData);
                }
            }
            appRoot.innerHTML = renderMapContent();
        }

        function saveToDB(data) {
            localStorage.setItem(DB_KEY, JSON.stringify(data));
            runtimeData = data; 
        }

        // [æ–°å¢é€»è¾‘] é‡æ–°è®¡ç®—å½“å‰æ‰€å¤„é˜¶æ®µ
        // è§„åˆ™ï¼šä»ç¬¬1é˜¶æ®µå¼€å§‹ï¼Œå¿…é¡»å®Œæˆè¯¥é˜¶æ®µæ‰€æœ‰ä»»åŠ¡æ‰èƒ½è¿›å…¥ä¸‹ä¸€é˜¶æ®µã€‚
        // ä¸€æ—¦é‡åˆ°æœªå…¨å®Œæˆçš„é˜¶æ®µï¼Œè¿›åº¦å°±åœåœ¨è¯¥é˜¶æ®µã€‚
        function recalculateCurrentStage() {
            let newStage = 1;
            for (let i = 0; i < STAGES.length - 1; i++) {
                const stage = STAGES[i];
                const completedTasks = runtimeData.campaign.completed_tasks[stage.id] || [];
                // å¦‚æœè¯¥é˜¶æ®µæœ‰ä»»åŠ¡ï¼Œä¸”ä»»åŠ¡å…¨éƒ¨å®Œæˆï¼Œæ‰æœ‰èµ„æ ¼æ™‹çº§
                if (stage.tasks.length > 0 && completedTasks.length === stage.tasks.length) {
                    newStage = stage.id + 1;
                } else {
                    // åªè¦æœ‰ä¸€ä¸ªé˜¶æ®µæ²¡å®Œæˆï¼Œè¿›åº¦å°±å¡åœ¨è¿™é‡Œï¼Œåé¢çš„éƒ½ä¸ç®—
                    break;
                }
            }
            return newStage;
        }

        // [ä¿®æ”¹é€»è¾‘] ä»»åŠ¡ç‚¹å‡»
        function toggleTask(stageId, taskIndex) {
            // åªæœ‰å½“å‰é˜¶æ®µæˆ–ä¹‹å‰çš„é˜¶æ®µå¯ä»¥æ“ä½œï¼ˆæœªæ¥çš„é˜¶æ®µè¿˜æ˜¯é”ä½ï¼‰
            // è¿™é‡Œçš„ currentStage å¯èƒ½æ˜¯é€šè¿‡â€œå·è·‘â€ä¸Šå»çš„ï¼Œæ‰€ä»¥ä¸»è¦é˜²çš„æ˜¯æœªè§£é”çš„
            if (stageId > runtimeData.campaign.current_stage) return;

            if (!runtimeData.campaign.completed_tasks[stageId]) {
                runtimeData.campaign.completed_tasks[stageId] = [];
            }
            const tasksArr = runtimeData.campaign.completed_tasks[stageId];
            const idxInArr = tasksArr.indexOf(taskIndex);
            
            // åˆ‡æ¢å‹¾é€‰çŠ¶æ€
            if (idxInArr === -1) {
                tasksArr.push(taskIndex);
            } else {
                tasksArr.splice(idxInArr, 1);
            }
            
            // æ ¸å¿ƒä¿®æ”¹ï¼šçŠ¶æ€å˜æ›´åï¼Œç«‹å³é‡æ–°è®¡ç®—å…¨å±€è¿›åº¦
            const oldStage = runtimeData.campaign.current_stage;
            const newStage = recalculateCurrentStage();
            runtimeData.campaign.current_stage = newStage;

            saveToDB(runtimeData);
            
            // åˆ·æ–° UI
            // å¦‚æœé˜¶æ®µå˜äº†ï¼ˆæ— è®ºæ˜¯å‡çº§è¿˜æ˜¯é™çº§ï¼‰ï¼Œéƒ½éœ€è¦åˆ·æ–°èƒŒåçš„åœ°å›¾
            if (oldStage !== newStage) {
                appRoot.innerHTML = renderMapContent();
                // å¦‚æœæ˜¯å‡çº§ï¼Œç»™ä¸ªæç¤º
                if (newStage > oldStage) {
                     // ç¨å¾®å»¶è¿Ÿä¸€ç‚¹ï¼Œä½“éªŒæ›´å¥½
                     setTimeout(() => {
                         alert(`æ­å–œï¼é˜¶æ®µ ${newStage-1} ä»»åŠ¡å…¨éƒ¨å®Œæˆã€‚\nå·²è§£é”é˜¶æ®µ ${newStage} (${STAGES[newStage-1].name})ã€‚`);
                     }, 100);
                }
            }
            
            // é‡æ–°æ¸²æŸ“å½“å‰æ¨¡æ€æ¡†ï¼ˆæ›´æ–°å‹¾é€‰çŠ¶æ€ï¼Œæˆ–è€…å¦‚æœåœ¨å½“å‰æ¨¡æ€æ¡†é‡Œé™çº§äº†ï¼Œæ ·å¼è¦å˜å›æœªå®Œæˆï¼‰
            openModal(stageId); 
        }

        // [åŸ checkStageCompletion å·²è¢«åºŸå¼ƒï¼Œé€»è¾‘åˆå¹¶å…¥ toggleTask å’Œ recalculateCurrentStage]

        // --- è§†å›¾æ¸²æŸ“ï¼šè¿›é˜¶åœ°å›¾ ---
        function renderMapContent() {
            const currentStage = runtimeData.campaign.current_stage;
            const totalStages = STAGES.length;
            
            const progressPercent = Math.max(0, ((currentStage - 1) / (totalStages - 1)) * 100);
            const lineStyle = `background: linear-gradient(to bottom, #10b981 0%, #10b981 ${progressPercent}%, #cbd5e1 ${progressPercent}%, #cbd5e1 100%);`;

            let nodesHtml = STAGES.map((stage) => {
                const isCurrent = stage.id === currentStage;
                const isPast = stage.id < currentStage;
                const isFinal = stage.id === 5; 

                let nodeStyle = "";
                let statusIcon = "";
                let labelColor = "";
                let hoverEffect = ""; 

                if (isCurrent) {
                    nodeStyle = "bg-emerald-500 text-white ring-4 ring-emerald-100 shadow-xl shadow-emerald-500/20 z-20 scale-110 animate-pulse-slow";
                    statusIcon = `<span class="text-xs font-bold tracking-widest">NOW</span>`;
                    labelColor = "text-emerald-600 font-bold";
                    hoverEffect = "group-hover:text-emerald-700"; 
                } else if (isPast) {
                    nodeStyle = "bg-white border-[3px] border-emerald-500 text-emerald-500 z-10 shadow-sm";
                    statusIcon = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>`;
                    labelColor = "text-emerald-600/70";
                    hoverEffect = "group-hover:text-emerald-600"; 
                } else {
                    nodeStyle = "bg-slate-50 border-2 border-slate-200 text-slate-300 z-10";
                    if (isFinal) {
                        statusIcon = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>`;
                    } else {
                        statusIcon = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>`;
                    }
                    labelColor = "text-slate-400";
                    hoverEffect = "group-hover:text-slate-600"; 
                }
                
                const clickAction = `onclick="openModal(${stage.id})"`;
                const isLeft = stage.id % 2 !== 0;
                
                return `
                    <div class="grid grid-cols-2 w-full max-w-2xl mx-auto relative group h-48 items-center" ${clickAction}>
                        <div class="flex ${isLeft ? 'justify-end pr-10 text-right' : 'col-start-2 justify-start pl-10 text-left'} items-center relative cursor-pointer">
                            <div class="${isLeft ? 'order-1 mr-5' : 'order-2 ml-5'} flex-1 min-w-0 transition-transform duration-300 group-hover:scale-105">
                                <h4 class="text-xl ${labelColor} transition-colors ${hoverEffect} tracking-wide font-bold uppercase">${stage.name}</h4>
                                <span class="text-[10px] text-slate-400 font-mono uppercase tracking-widest group-hover:text-emerald-500 transition-colors block mt-1">${stage.en_name}</span>
                            </div>
                            <div class="w-16 h-16 rounded-full flex items-center justify-center transition-all duration-300 ${nodeStyle} shrink-0 ${isLeft ? 'order-2' : 'order-1'} relative">
                                ${statusIcon}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="py-8 min-h-full flex flex-col items-center animate-fade-in relative w-full">
                    <div class="absolute left-1/2 top-24 bottom-24 w-1 -translate-x-1/2 z-0 rounded-full" style="${lineStyle}"></div>
                    <div class="w-full relative z-10">
                        ${nodesHtml}
                    </div>
                    <div class="py-8 text-center opacity-40">
                        <p class="text-slate-400 text-[10px] tracking-[0.3em] uppercase">Project Eros // Campaign Map</p>
                    </div>
                </div>
            `;
        }

        // --- æ¨¡æ€æ¡†é€»è¾‘ ---
        window.openModal = function(stageId) {
            const stage = STAGES.find(s => s.id === stageId);
            if (!stage) return;
            
            document.getElementById('modal-title').innerText = `${stage.name} (${stage.en_name})`;
            const modalBody = document.getElementById('modal-body');

            const currentStage = runtimeData.campaign.current_stage;
            const isUnlocked = stageId <= currentStage; // åªè¦è§£é”äº†å°±å¯ä»¥çœ‹/æ”¹
            const completedIndices = runtimeData.campaign.completed_tasks[stageId] || [];

            let htmlContent = `
                <div class="bg-slate-50 p-4 rounded-lg border border-slate-100 mb-6">
                    <p class="text-sm text-slate-600 leading-relaxed italic">"${stage.definition}"</p>
                </div>`;

            if (isUnlocked) {
                if (stage.actions) {
                    htmlContent += `
                        <div class="mb-5">
                            <h4 class="text-xs font-bold text-emerald-600 mb-2 uppercase tracking-wider flex items-center">
                                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 mr-2"></span>å…³é”®è¡ŒåŠ¨ (DOs)
                            </h4>
                            <ul class="space-y-2">${stage.actions.map(a => `<li class="text-sm text-slate-600 pl-4 border-l border-emerald-200">${a}</li>`).join('')}</ul>
                        </div>`;
                }
                if (stage.taboos) {
                    htmlContent += `
                        <div class="mb-5">
                            <h4 class="text-xs font-bold text-amber-600 mb-2 uppercase tracking-wider flex items-center">
                                <span class="w-1.5 h-1.5 rounded-full bg-amber-500 mr-2"></span>ç¦å¿Œè¡Œä¸º (DON'Ts)
                            </h4>
                            <ul class="space-y-2">${stage.taboos.map(t => `<li class="text-sm text-slate-600 pl-4 border-l border-amber-200">${t}</li>`).join('')}</ul>
                        </div>`;
                }
                
                if (stage.tasks && stage.tasks.length > 0) {
                    htmlContent += `
                        <div class="pt-5 border-t border-slate-100">
                            <h4 class="text-xs font-bold text-slate-700 mb-3 uppercase tracking-wider">æ™‹å‡ä»»åŠ¡ (Self-Check)</h4>
                            <div class="space-y-2">`;
                    
                    stage.tasks.forEach((taskText, index) => {
                        // [ä¿®æ”¹é€»è¾‘] ä¸¥æ ¼åˆ¤å®šæ˜¯å¦å‹¾é€‰ï¼Œä¸å†å› ä¸ºé˜¶æ®µè¿‡å»å°±å¼ºåˆ¶å‹¾é€‰
                        const isChecked = completedIndices.includes(index);
                        
                        // [ä¿®æ”¹é€»è¾‘] åªè¦æ˜¯è§£é”çš„é˜¶æ®µï¼ˆ<= currentStageï¼‰ï¼Œéƒ½å¯ä»¥æ“ä½œ
                        // åªæœ‰æœªæ¥çš„é˜¶æ®µï¼ˆ> currentStageï¼‰æ‰æ˜¯ disabled
                        const isDisabled = stageId > currentStage; 
                        
                        let divClass = "flex items-start p-3 rounded-lg border transition-all duration-200 ";
                        let iconClass = "w-4 h-4 rounded border flex items-center justify-center transition-colors flex-shrink-0 mt-0.5 mr-3 ";
                        let textClass = "text-sm transition-colors ";

                        if (isChecked) {
                            // [ä¿®æ”¹æ ·å¼] è™½ç„¶æ˜¯ completedï¼Œä½†ä¸ºäº†è¡¨æ˜å¯äº¤äº’ï¼ˆå¯å–æ¶ˆï¼‰ï¼ŒåŠ ä¸Š cursor-pointer
                            divClass += "bg-emerald-50 border-emerald-200 cursor-pointer hover:bg-emerald-100";
                            iconClass += "bg-emerald-500 border-emerald-500 text-white";
                            textClass += "text-emerald-800 line-through decoration-emerald-500/30";
                        } else if (isDisabled) {
                            divClass += "bg-slate-50 border-slate-100 cursor-not-allowed opacity-50";
                            iconClass += "border-slate-300 bg-transparent";
                            textClass += "text-slate-400";
                        } else {
                            divClass += "bg-white border-slate-300 cursor-pointer hover:border-emerald-400 hover:shadow-sm";
                            iconClass += "border-slate-400 bg-white group-hover:border-emerald-500";
                            textClass += "text-slate-600";
                        }

                        htmlContent += `
                            <div class="${divClass}" ${!isDisabled ? `onclick="toggleTask(${stageId}, ${index})"` : ''}>
                                <div class="${iconClass}">
                                    ${isChecked ? '<svg class="w-2.5 h-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>' : ''}
                                </div>
                                <span class="${textClass}">${taskText}</span>
                            </div>`;
                    });
                    htmlContent += `</div></div>`;
                } else if (stage.id === 5) {
                    htmlContent += `
                        <div class="pt-5 border-t border-slate-100 text-center">
                            <p class="text-emerald-600 font-bold text-sm">ğŸ‰ æ­å–œè¾¾æˆæœ€ç»ˆç›®æ ‡</p>
                        </div>
                    `;
                }
            } else {
                htmlContent += `
                    <div class="py-8 text-center border-t border-slate-100 mt-4">
                        <div class="w-10 h-10 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-3 text-slate-300">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                        </div>
                        <p class="text-xs text-slate-400">è¯·å…ˆè§£é”å‰ç½®èº«ä»½</p>
                    </div>`;
            }

            modalBody.innerHTML = htmlContent;
            
            const actionBtn = document.querySelector('#modal-content button.bg-eros-accent');
            if (actionBtn) {
                actionBtn.style.display = 'none';
            }

            modalOverlay.classList.remove('hidden');
            setTimeout(() => { modalOverlay.classList.remove('opacity-0'); modalContent.classList.remove('scale-95'); modalContent.classList.add('scale-100'); }, 10);
        }
        
        window.toggleModal = function(show) {
            if (!show) {
                modalOverlay.classList.add('opacity-0'); modalContent.classList.remove('scale-100'); modalContent.classList.add('scale-95');
                setTimeout(() => modalOverlay.classList.add('hidden'), 300);
            }
        }
        window.closeModal = function(e) { if (e.target === modalOverlay) toggleModal(false); }
        
        window.onload = init;
    </script>
</body>
</html>