<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Training Logs - Project Eros</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        eros: {
                            dark: '#f1f5f9',
                            panel: '#ffffff',
                            accent: '#059669', 
                            blue: '#3b82f6',
                            orange: '#fb923c' 
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f1f5f9; color: #334155; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .timeline-line::before {
            content: ''; position: absolute; top: 0; bottom: 0; left: 23px; width: 2px; background: #e2e8f0; z-index: 0;
        }
        input[type="time"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            filter: invert(0.5);
        }
    </style>
</head>
<!-- [修改点1] 手机端取消 overflow-hidden，改为 h-[100dvh] 以适配动态地址栏，PC端保持 md:overflow-hidden -->
<body class="h-[100dvh] w-screen overflow-hidden flex flex-col">

    <!-- [修改点2] 主容器在手机端允许原生垂直滚动 (overflow-y-auto)，PC端保持锁定 -->
    <div class="flex-1 flex flex-col md:flex-row overflow-y-auto md:overflow-hidden">
        
        <!-- 左侧：战术日历 (取消移动端 max-h 限制，让它自然撑开) -->
        <aside class="w-full md:w-80 bg-slate-50 border-b md:border-b-0 md:border-r border-slate-200 flex flex-col flex-shrink-0 z-20 h-auto md:h-full">
            <!-- 统计区 -->
            <div class="p-4 md:p-6 border-b border-slate-200 bg-white">
                <div class="flex justify-between items-end mb-1">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Current Streak</span>
                    <i class="fa-solid fa-fire text-orange-400 animate-pulse"></i>
                </div>
                <div class="text-3xl md:text-4xl font-extrabold text-emerald-600 tracking-tight" id="streak-display">
                    -- <span class="text-base md:text-lg text-emerald-400 font-normal ml-1">DAYS</span>
                </div>
                <div class="mt-3 md:mt-4 h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
                    <div id="month-progress" class="h-full bg-emerald-500 rounded-full" style="width: 0%"></div>
                </div>
                <div class="mt-1 text-[10px] text-slate-400 text-right">本月活跃度</div>
            </div>

            <!-- 日历网格 (PC端保留滚动，移动端由于外层会滚动，这里不再强制设限) -->
            <div class="p-4 md:flex-1 md:overflow-y-auto scrollbar-hide">
                <div class="flex justify-between items-center mb-4 px-2">
                    <button onclick="changeMonth(-1)" class="text-slate-400 hover:text-emerald-600 p-2 -ml-2"><i class="fa-solid fa-chevron-left"></i></button>
                    <span id="calendar-month-label" class="text-sm font-bold text-slate-700">Loading...</span>
                    <button onclick="changeMonth(1)" class="text-slate-400 hover:text-emerald-600 p-2 -mr-2"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
                
                <div class="grid grid-cols-7 gap-1 text-center mb-2">
                    <span class="text-[10px] text-slate-300 font-bold">MON</span>
                    <span class="text-[10px] text-slate-300 font-bold">TUE</span>
                    <span class="text-[10px] text-slate-300 font-bold">WED</span>
                    <span class="text-[10px] text-slate-300 font-bold">THU</span>
                    <span class="text-[10px] text-slate-300 font-bold">FRI</span>
                    <span class="text-[10px] text-slate-300 font-bold">SAT</span>
                    <span class="text-[10px] text-slate-300 font-bold">SUN</span>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-1 md:gap-2">
                    <!-- JS 生成 -->
                </div>
            </div>
            
            <!-- 图例 -->
            <div class="p-3 border-t border-slate-200 bg-slate-50 text-[10px] text-slate-400 flex justify-around flex-shrink-0">
                <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-blue-400"></div>硬件</div>
                <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-orange-300"></div>行动</div>
                <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-emerald-500"></div>完美</div>
            </div>
        </aside>

        <!-- 右侧：每日复盘 (移动端自然高度，PC端填充剩余空间) -->
        <main class="flex-1 flex flex-col bg-white relative z-10 h-auto md:h-full">
            
            <!-- 1. 顶部 HUD：[修改点3] 手机端使用 grid-cols-2 完美平分宽度，拒绝错位 -->
            <div class="py-4 md:py-0 md:h-20 border-b border-slate-100 flex flex-col md:flex-row items-start md:items-center justify-between px-4 md:px-8 bg-slate-50/50 flex-shrink-0">
                <div class="flex items-center gap-3 w-full md:w-auto mb-3 md:mb-0">
                    <div class="p-2 bg-slate-200 rounded text-slate-500">
                        <i class="fa-regular fa-calendar-check text-xl"></i>
                    </div>
                    <div>
                        <div id="selected-date-label" class="text-base md:text-lg font-bold text-slate-700 font-mono">--</div>
                        <div class="text-[10px] md:text-xs text-slate-400">DAILY DEBRIEFING</div>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:flex gap-3 w-full md:w-auto">
                    <!-- Body Status -->
                    <div id="hud-body" class="flex items-center gap-3 px-3 py-2 bg-white rounded-lg border border-slate-200 shadow-sm opacity-50">
                        <div class="w-2 h-2 rounded-full bg-slate-300 flex-shrink-0"></div>
                        <div class="min-w-0">
                            <div class="text-[10px] text-slate-400 font-bold uppercase truncate">Body</div>
                            <div class="text-xs font-bold text-slate-600 truncate"><span id="val-body">0</span>/5 Checks</div>
                        </div>
                    </div>
                    <!-- Kegel Status -->
                    <div id="hud-kegel" class="flex items-center gap-3 px-3 py-2 bg-white rounded-lg border border-slate-200 shadow-sm opacity-50">
                        <div class="w-2 h-2 rounded-full bg-slate-300 flex-shrink-0"></div>
                        <div class="min-w-0">
                            <div class="text-[10px] text-slate-400 font-bold uppercase truncate">Kegel</div>
                            <div class="text-xs font-bold text-slate-600 truncate" id="val-kegel">0 Sets</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. 中部：作战时间轴 (移动端设置 min-h，保证无数据时也有足够空间) -->
            <div id="timeline-container" class="flex-1 p-4 md:p-8 relative timeline-line min-h-[300px] md:min-h-0 md:overflow-y-auto">
                <div class="text-center mt-20 text-slate-400 text-sm">选择日期查看记录...</div>
            </div>

            <!-- 3. 底部：战术记录器 [修改点4] 重新梳理手机端换行逻辑，将时间和心态提至顶部两端对齐 -->
            <div class="p-4 md:p-6 border-t border-slate-200 bg-slate-50 flex-shrink-0 z-10 shadow-[0_-5px_15px_rgba(0,0,0,0.02)]">
                
                <div class="flex flex-col md:flex-row justify-between mb-4 gap-4 md:gap-0">
                    
                    <!-- 移动端优先显示：右侧工具栏 (时间、心态) 提至上方，避免和标签抢空间 -->
                    <div class="flex items-center justify-between w-full md:w-auto order-1 md:order-2">
                        <div class="flex items-center gap-2 bg-white px-2 py-1.5 rounded-lg border border-slate-200 shadow-sm" title="修改记录时间（补录）">
                            <i class="fa-regular fa-clock text-slate-400 text-xs"></i>
                            <input type="time" id="log-time-picker" class="text-xs font-mono font-bold text-slate-600 bg-transparent outline-none border-none h-4 w-16">
                        </div>

                        <div class="flex items-center gap-2 bg-white px-3 py-1.5 rounded-lg border border-slate-200 shadow-sm">
                            <span class="text-[10px] font-bold text-slate-400 uppercase">Mindset</span>
                            <input type="range" min="1" max="10" value="5" class="w-20 md:w-24 h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-emerald-500" id="mindset-slider" oninput="document.getElementById('mindset-val').innerText=this.value">
                            <span id="mindset-val" class="text-xs font-bold text-emerald-600 w-4 text-center">5</span>
                        </div>
                    </div>

                    <!-- 标签区 -->
                    <div class="flex flex-wrap gap-2 order-2 md:order-1 w-full md:w-auto" id="tag-selector">
                        <button onclick="toggleInputTag(this)" class="tag-btn text-xs font-bold px-3 py-1.5 bg-white border border-slate-200 rounded-full text-slate-500 hover:border-emerald-500 hover:text-emerald-600 transition" data-tag="#搭讪">#搭讪</button>
                        <button onclick="toggleInputTag(this)" class="tag-btn text-xs font-bold px-3 py-1.5 bg-white border border-slate-200 rounded-full text-slate-500 hover:border-emerald-500 hover:text-emerald-600 transition" data-tag="#聊天">#聊天</button>
                        <button onclick="toggleInputTag(this)" class="tag-btn text-xs font-bold px-3 py-1.5 bg-white border border-slate-200 rounded-full text-slate-500 hover:border-emerald-500 hover:text-emerald-600 transition" data-tag="#沟通">#沟通</button>
                        <button onclick="toggleInputTag(this)" class="tag-btn text-xs font-bold px-3 py-1.5 bg-white border border-slate-200 rounded-full text-slate-500 hover:border-emerald-500 hover:text-emerald-600 transition" data-tag="#约会">#约会</button>
                        <button onclick="toggleInputTag(this)" class="tag-btn text-xs font-bold px-3 py-1.5 bg-white border border-slate-200 rounded-full text-slate-500 hover:border-emerald-500 hover:text-emerald-600 transition" data-tag="#过夜">#过夜</button>
                    </div>

                </div>

                <div class="relative">
                    <textarea id="log-input" class="w-full h-24 md:h-20 bg-white border border-slate-300 rounded-xl p-3 md:p-4 text-sm focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 transition resize-none shadow-sm" placeholder="记录今日的战术执行情况、心态变化或复盘总结..."></textarea>
                    <button onclick="submitLog()" class="absolute bottom-2 md:bottom-3 right-2 md:right-3 bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-bold px-4 py-2 rounded-lg transition shadow-md flex items-center gap-2">
                        <i class="fa-solid fa-paper-plane"></i> LOG
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- 全局配置与状态 ---
        const KEYS = {
            EDGE: 'edge_history',
            KEGEL: 'kegel_history',
            BODY: 'body_builder_data',
            LOGS: 'eros_daily_logs'
        };

        let currentDate = new Date(); 
        let selectedDateStr = getLocalDayStr(new Date()); 
        let selectedTags = [];

        // --- 辅助函数 ---
        function getLocalDayStr(dateObj) {
            const year = dateObj.getFullYear();
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatTime(timestamp) {
            const d = new Date(timestamp);
            return `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
        }

        // --- 数据加载器 ---
        function loadData(key) {
            try {
                return JSON.parse(localStorage.getItem(key) || (key === KEYS.BODY || key === KEYS.LOGS ? '{}' : '[]'));
            } catch (e) {
                console.error("Data Load Error", e);
                return key === KEYS.BODY || key === KEYS.LOGS ? {} : [];
            }
        }

        // --- 核心：日历渲染 ---
        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('calendar-month-label').innerText = 
                currentDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });

            const firstDay = new Date(year, month, 1).getDay(); 
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const startOffset = firstDay === 0 ? 6 : firstDay - 1;

            const edgeData = loadData(KEYS.EDGE);
            const kegelData = loadData(KEYS.KEGEL);
            const bodyData = loadData(KEYS.BODY);
            const logsData = loadData(KEYS.LOGS);

            for(let i=0; i<startOffset; i++) {
                grid.innerHTML += `<div></div>`;
            }

            let activeDays = 0;
            for(let d=1; d<=daysInMonth; d++) {
                const dateObj = new Date(year, month, d);
                const dayStr = getLocalDayStr(dateObj);
                const isSelected = dayStr === selectedDateStr;
                const isToday = dayStr === getLocalDayStr(new Date());

                const hasEdge = edgeData.some(i => getLocalDayStr(new Date(i.date)) === dayStr);
                const hasKegel = kegelData.some(i => getLocalDayStr(new Date(i.date)) === dayStr);
                const bodyRaw = bodyData[dayStr];
                
                const hasBody = bodyRaw && (
                    (Array.isArray(bodyRaw) && bodyRaw.some(Boolean)) || 
                    (bodyRaw.state && Array.isArray(bodyRaw.state) && bodyRaw.state.some(Boolean))
                );
                const isHardwareActive = hasEdge || hasKegel || hasBody;

                const hasLogs = logsData[dayStr] && logsData[dayStr].length > 0;

                if (isHardwareActive || hasLogs) activeDays++;

                // 微调了数字字体大小，使其在移动端更精致
                let baseClass = "aspect-square rounded-lg border flex flex-col items-center justify-center relative group cursor-pointer transition-all duration-200 ";
                if (isSelected) baseClass += "bg-slate-200 border-slate-300 text-slate-700 shadow-sm scale-105 z-10 ";
                else if (isToday) baseClass += "bg-white border-emerald-400 text-emerald-600 ";
                else baseClass += "bg-white border-slate-100 text-slate-500 hover:border-emerald-300 ";

                let dotHtml = '';
                if (isHardwareActive && hasLogs) {
                    dotHtml = `<div class="mt-1 w-1.5 h-1.5 rounded-full bg-emerald-500"></div>`;
                } else if (hasLogs) {
                    dotHtml = `<div class="mt-1 w-1.5 h-1.5 rounded-full bg-orange-300"></div>`;
                } else if (isHardwareActive) {
                    dotHtml = `<div class="mt-1 w-1.5 h-1.5 rounded-full bg-blue-400"></div>`;
                } else {
                    dotHtml = `<div class="mt-1 w-1.5 h-1.5"></div>`;
                }

                if (isHardwareActive && hasLogs && !isSelected) {
                    baseClass += "ring-1 ring-emerald-100 bg-emerald-50/30 ";
                }

                const el = document.createElement('div');
                el.className = baseClass;
                el.onclick = () => selectDate(dayStr);
                el.innerHTML = `
                    <span class="text-xs md:text-sm font-bold">${d}</span>
                    ${dotHtml}
                `;
                grid.appendChild(el);
            }

            document.getElementById('month-progress').style.width = `${(activeDays / daysInMonth) * 100}%`;
            document.getElementById('streak-display').innerHTML = `${calcTrueStreak()} <span class="text-base md:text-lg text-emerald-400 font-normal ml-1">DAYS</span>`;
        }

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderCalendar();
        }

        function selectDate(dayStr) {
            selectedDateStr = dayStr;
            renderCalendar();
            renderTimeline();
        }

        function calcTrueStreak() {
            const edgeData = loadData(KEYS.EDGE);
            const kegelData = loadData(KEYS.KEGEL);
            const bodyData = loadData(KEYS.BODY);
            const logsData = loadData(KEYS.LOGS);

            const hasActivity = (dStr) => {
                const hasEdge = edgeData.some(i => getLocalDayStr(new Date(i.date)) === dStr);
                const hasKegel = kegelData.some(i => getLocalDayStr(new Date(i.date)) === dStr);
                const bodyRaw = bodyData[dStr];
                const hasBody = bodyRaw && (
                    (Array.isArray(bodyRaw) && bodyRaw.some(Boolean)) || 
                    (bodyRaw.state && Array.isArray(bodyRaw.state) && bodyRaw.state.some(Boolean))
                );
                const hasLogs = logsData[dStr] && logsData[dStr].length > 0;
                return hasEdge || hasKegel || hasBody || hasLogs;
            };

            let streak = 0;
            let checkDate = new Date();
            let checkStr = getLocalDayStr(checkDate);

            if (!hasActivity(checkStr)) {
                checkDate.setDate(checkDate.getDate() - 1);
                checkStr = getLocalDayStr(checkDate);
            }

            while (hasActivity(checkStr)) {
                streak++;
                checkDate.setDate(checkDate.getDate() - 1);
                checkStr = getLocalDayStr(checkDate);
                if (streak > 3650) break;
            }

            return streak;
        }

        function updateHUD() {
            document.getElementById('selected-date-label').innerText = selectedDateStr;
            
            const bodyData = loadData(KEYS.BODY);
            const bodyRaw = bodyData[selectedDateStr];
            let bodyChecks = 0;
            if (bodyRaw) {
                if (bodyRaw.state && Array.isArray(bodyRaw.state)) {
                    bodyChecks = bodyRaw.state.filter(Boolean).length;
                } else if (Array.isArray(bodyRaw)) {
                    bodyChecks = bodyRaw.flat().filter(Boolean).length;
                    if(bodyChecks > 5) bodyChecks = 5;
                }
            }
            
            const bodyEl = document.getElementById('hud-body');
            document.getElementById('val-body').innerText = bodyChecks;
            
            if (bodyChecks === 5) {
                bodyEl.className = "flex items-center gap-3 px-3 py-2 bg-emerald-50 rounded-lg border border-emerald-200 shadow-sm opacity-100 transition";
                bodyEl.querySelector('.rounded-full').className = "w-2 h-2 rounded-full bg-emerald-500 animate-pulse flex-shrink-0";
            } else {
                bodyEl.className = "flex items-center gap-3 px-3 py-2 bg-white rounded-lg border border-slate-200 shadow-sm opacity-60 transition";
                bodyEl.querySelector('.rounded-full').className = "w-2 h-2 rounded-full bg-slate-300 flex-shrink-0";
            }

            const kegelData = loadData(KEYS.KEGEL);
            const kCount = kegelData.filter(i => getLocalDayStr(new Date(i.date)) === selectedDateStr).length;
            const kegelEl = document.getElementById('hud-kegel');
            document.getElementById('val-kegel').innerText = kCount + " Sets";

            if (kCount >= 3) {
                kegelEl.className = "flex items-center gap-3 px-3 py-2 bg-blue-50 rounded-lg border border-blue-200 shadow-sm opacity-100 transition";
                kegelEl.querySelector('.rounded-full').className = "w-2 h-2 rounded-full bg-blue-500 animate-pulse flex-shrink-0";
            } else {
                kegelEl.className = "flex items-center gap-3 px-3 py-2 bg-white rounded-lg border border-slate-200 shadow-sm opacity-60 transition";
                kegelEl.querySelector('.rounded-full').className = "w-2 h-2 rounded-full bg-slate-300 flex-shrink-0";
            }
        }

        function renderTimeline() {
            updateHUD();
            const container = document.getElementById('timeline-container');
            container.innerHTML = '';

            let timelineItems = [];

            const edgeData = loadData(KEYS.EDGE);
            edgeData.filter(i => getLocalDayStr(new Date(i.date)) === selectedDateStr).forEach(item => {
                timelineItems.push({ type: 'edge', ts: new Date(item.date).getTime(), data: item });
            });

            const logsData = loadData(KEYS.LOGS);
            if (logsData[selectedDateStr]) {
                logsData[selectedDateStr].forEach(item => {
                    timelineItems.push({ type: 'log', ts: item.timestamp, data: item });
                });
            }

            timelineItems.sort((a, b) => a.ts - b.ts);

            if (timelineItems.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-slate-300 mt-10 md:mt-20">
                        <i class="fa-regular fa-clipboard text-4xl mb-4 opacity-50"></i>
                        <p class="text-sm font-mono">NO DATA RECORDED</p>
                    </div>
                `;
                return;
            }

            timelineItems.forEach(item => {
                const timeStr = formatTime(item.ts);
                let html = '';

                if (item.type === 'edge') {
                    html = renderEdgeCard(timeStr, item.data);
                } else if (item.type === 'log') {
                    html = renderUserLog(timeStr, item.data);
                }
                
                container.innerHTML += html;
            });
        }

        function renderUserLog(time, data) {
            const tagsHtml = data.tags.map(t => 
                `<span class="text-[10px] font-bold px-1.5 py-0.5 bg-emerald-100 text-emerald-700 rounded">${t}</span>`
            ).join('');

            return `
                <div class="flex gap-4 mb-6 relative z-10">
                    <div class="w-12 md:w-16 text-right text-xs font-mono text-slate-500 font-bold pt-1 flex-shrink-0">${time}</div>
                    <div class="w-px bg-slate-200 relative mx-1 md:mx-2 flex-shrink-0">
                        <div class="absolute -left-[5px] top-1.5 w-3 h-3 rounded-full border-2 border-emerald-500 bg-white"></div>
                    </div>
                    <div class="flex-1 pb-4 min-w-0">
                        <div class="bg-emerald-50/50 border border-emerald-100 rounded-lg p-3 hover:shadow-sm transition">
                            <div class="flex flex-wrap gap-2 mb-2 items-center">
                                ${tagsHtml}
                                <span class="text-[10px] font-bold px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded whitespace-nowrap">心态: ${data.mindset}/10</span>
                            </div>
                            <p class="text-sm text-slate-700 leading-relaxed whitespace-pre-wrap break-words">${data.content}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderEdgeCard(time, data) {
            const duration = data.duration || 0;
            const expected = data.expectedDuration || duration;
            const isSuccess = duration >= expected;
            const isSprint = duration > expected;
            const timelineBase = duration > 0 ? duration : 1;
            
            let greenWidth = 0;
            if (isSuccess) greenWidth = (expected / timelineBase) * 100;
            else greenWidth = 100;

            const mainBarColor = isSuccess ? 'bg-emerald-500' : 'bg-orange-200';

            let sprintStyle = '';
            let sprintLineHtml = '';

            if (isSprint) {
                const sprintWidth = ((duration - expected) / timelineBase) * 100;
                sprintStyle = `left: ${greenWidth}%; width: ${sprintWidth}%;`;
                sprintLineHtml = `<div class="absolute top-0 bottom-0 w-[1px] bg-white z-20 shadow-[0_0_4px_rgba(255,255,255,0.8)]" style="left: ${greenWidth}%"></div>`;
            }

            let markersHtml = '';
            if (data.markersData) {
                for (let i = 0; i < data.markersData.length; i++) {
                    const m = data.markersData[i];
                    if (m.type === 'edge') {
                        const start = m.elapsed;
                        let end = timelineBase;
                        for (let j = i + 1; j < data.markersData.length; j++) {
                            if (data.markersData[j].type === 'resume') {
                                end = data.markersData[j].elapsed;
                                break;
                            }
                        }
                        const left = (start / timelineBase) * 100;
                        const width = ((end - start) / timelineBase) * 100;
                        markersHtml += `<div class="absolute top-0 bottom-0 bg-cyan-300/80 backdrop-blur-[1px] z-10 border-l border-white/20" style="left: ${left}%; width: ${width}%"></div>`;
                    }
                }
            }

            let footerHtml = '';
            if ((data.tags && data.tags.length > 0) || data.comment) {
                const tHtml = (data.tags || []).map(t => `<span class="px-2 py-1 bg-blue-50 text-blue-600 rounded text-xs font-bold border border-blue-100 whitespace-nowrap">${t}</span>`).join('');
                const cHtml = data.comment ? `<div class="p-2 bg-slate-50 rounded text-xs text-slate-600 italic border border-slate-100 mt-2 break-words">"${data.comment}"</div>` : '';
                footerHtml = `<div class="px-3 md:px-5 pb-4 pt-0 border-t border-slate-50 mt-4 pt-3"><div class="flex flex-wrap gap-2">${tHtml}</div>${cHtml}</div>`;
            } else {
                footerHtml = `<div class="px-5 pb-4"></div>`;
            }
            
            const m = Math.floor(duration / 60).toString().padStart(2, '0');
            const s = (duration % 60).toString().padStart(2, '0');

            return `
                <div class="flex gap-4 group mb-6 relative z-10">
                    <div class="w-12 md:w-16 text-right text-xs font-mono text-slate-400 pt-1 flex-shrink-0">${time}</div>
                    
                    <div class="w-px bg-slate-200 relative mx-1 md:mx-2 flex-shrink-0">
                        <div class="absolute -left-[4px] top-1.5 w-2.5 h-2.5 rounded-full border-2 border-orange-300 bg-white"></div>
                    </div>
                    
                    <div class="flex-1 pb-2 min-w-0">
                        <div class="bg-white border border-slate-200 rounded-xl overflow-hidden shadow-sm hover:shadow-md transition">
                            <div class="bg-slate-50 p-3 border-b border-slate-100 flex justify-between items-center bg-orange-50/30">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-lg bg-orange-100 text-orange-600 flex items-center justify-center shrink-0">
                                        <i class="fa-solid fa-stopwatch"></i>
                                    </div>
                                    <div class="min-w-0">
                                        <div class="text-sm font-bold text-slate-700 truncate">Edge Control</div>
                                        <div class="text-[10px] text-slate-400">Time: ${m}:${s} · ${data.difficulty || 'L2'}</div>
                                    </div>
                                </div>
                                <div class="text-right shrink-0">
                                    <div class="text-lg font-bold text-blue-600 font-mono">${data.ratio || '--%'}</div>
                                    <div class="text-[10px] text-slate-400 uppercase">Efficiency</div>
                                </div>
                            </div>
                            <div class="p-3 md:p-5 pb-0">
                                <div class="text-[10px] text-slate-400 mb-2 flex justify-between">
                                    <span>Session Timeline</span>
                                    <span class="font-mono text-orange-400 font-bold">${data.edgeCount || 0} Edges</span>
                                </div>
                                <div class="relative w-full h-3 bg-slate-100 rounded-full overflow-hidden">
                                    <div class="absolute left-0 top-0 bottom-0 ${mainBarColor}" style="width: ${greenWidth}%"></div>
                                    <div class="absolute top-0 bottom-0 bg-gradient-to-r from-emerald-500 via-blue-500 to-purple-600" style="${sprintStyle}"></div>
                                    ${sprintLineHtml}
                                    ${markersHtml}
                                </div>
                                <div class="flex justify-between text-[10px] text-slate-300 font-mono mt-1">
                                    <span>00:00</span>
                                    <span>${m}:${s}</span>
                                </div>
                            </div>
                            ${footerHtml}
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleInputTag(btn) {
            const tag = btn.dataset.tag;
            if (selectedTags.includes(tag)) {
                selectedTags = selectedTags.filter(t => t !== tag);
                btn.classList.remove('bg-emerald-100', 'text-emerald-700', 'border-emerald-200');
                btn.classList.add('bg-white', 'text-slate-500', 'border-slate-200');
            } else {
                selectedTags.push(tag);
                btn.classList.remove('bg-white', 'text-slate-500', 'border-slate-200');
                btn.classList.add('bg-emerald-100', 'text-emerald-700', 'border-emerald-200');
            }
        }

        function submitLog() {
            const content = document.getElementById('log-input').value.trim();
            const mindset = document.getElementById('mindset-slider').value;
            const timePicker = document.getElementById('log-time-picker');
            
            if (!content && selectedTags.length === 0) return alert("写点什么或者选个标签吧。");

            const logs = loadData(KEYS.LOGS);
            if (!logs[selectedDateStr]) logs[selectedDateStr] = [];

            let finalTimestamp = Date.now();
            if (timePicker && timePicker.value) {
                const dateTimeStr = `${selectedDateStr}T${timePicker.value}:00`;
                const d = new Date(dateTimeStr);
                if (!isNaN(d.getTime())) {
                    finalTimestamp = d.getTime();
                }
            }

            const newLog = {
                id: crypto.randomUUID(),
                timestamp: finalTimestamp, 
                content: content,
                tags: [...selectedTags],
                mindset: mindset
            };

            logs[selectedDateStr].push(newLog);
            localStorage.setItem(KEYS.LOGS, JSON.stringify(logs));

            document.getElementById('log-input').value = '';
            selectedTags = [];
            document.querySelectorAll('.tag-btn').forEach(btn => {
                btn.classList.remove('bg-emerald-100', 'text-emerald-700', 'border-emerald-200');
                btn.classList.add('bg-white', 'text-slate-500', 'border-slate-200');
            });
            timePicker.value = '';
            setDefaultTime();

            renderCalendar(); 
            renderTimeline();
            
            // 提交后移动端自动滚动到日志底部，提升体验
            const container = document.getElementById('timeline-container');
            if(window.innerWidth < 768 && container) {
               container.scrollIntoView({behavior: 'smooth', block: 'end'});
            }
        }

        function setDefaultTime() {
            const now = new Date();
            const hh = String(now.getHours()).padStart(2, '0');
            const mm = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('log-time-picker').value = `${hh}:${mm}`;
        }

        window.onload = function() {
            setDefaultTime();
            renderCalendar();
            renderTimeline();
        };

    </script>
</body>
</html>
